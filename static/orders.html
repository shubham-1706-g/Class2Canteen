<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>My Orders</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
        href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Space+Grotesk%3Awght%40400%3B500%3B700" />
    <style>
        .content-container {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .content-container.loaded {
            opacity: 1;
        }

        .order-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }

        .order-toggle .chevron {
            transition: transform 0.4s ease-in-out;
        }

        .order-toggle.open .chevron {
            transform: rotate(180deg);
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="mx-auto max-w-sm">
        <div class="relative bg-[#fcfbf8] min-h-screen">
            <!-- Main content area -->
            <div class="pb-24">
                <div class="content-container">
                    <div class="flex items-center bg-[#fcfbf8] p-4 pb-2 justify-between">
                        <a href="./home.html" class="text-[#1c1a0d] flex size-12 shrink-0 items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                                viewBox="0 0 256 256">
                                <path
                                    d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z">
                                </path>
                            </svg>
                        </a>
                        <h2
                            class="text-[#1c1a0d] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">
                            My Orders</h2>
                    </div>

                    <div id="ongoing-orders-section">
                        <h3 class="text-[#1c1a0d] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">
                            Ongoing Orders</h3>
                        <div id="ongoing-orders-container" class="px-4 flex flex-col gap-3">
                            <!-- Ongoing orders will be dynamically inserted here -->
                        </div>
                    </div>

                    <div id="past-orders-section">
                        <h3 class="text-[#1c1a0d] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-6">
                            Past Orders</h3>
                        <div id="past-orders-container" class="px-4 flex flex-col gap-3">
                            <!-- Past orders will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- Navigation Bar (remains the same) -->
            <div class="fixed bottom-0 z-10 w-full max-w-sm">
                <div class="flex justify-around border-t border-[#f3f2e7] bg-[#fcfbf8] px-2 pb-3 pt-2">
                    <a class="flex flex-1 flex-col items-center justify-end gap-1 text-[#9b924b]" href="./home.html">
                        <div class="flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg"
                                width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                <path
                                    d="M218.83,103.77l-80-75.48a1.14,1.14,0,0,1-.11-.11,16,16,0,0,0-21.53,0l-.11.11L37.17,103.77A16,16,0,0,0,32,115.55V208a16,16,0,0,0,16,16H96a16,16,0,0,0,16-16V160h32v48a16,16,0,0,0,16,16h48a16,16,0,0,0,16-16V115.55A16,16,0,0,0,218.83,103.77ZM208,208H160V160a16,16,0,0,0-16-16H112a16,16,0,0,0-16,16v48H48V115.55l.11-.1L128,40l79.9,75.43.11.1Z">
                                </path>
                            </svg></div>
                        <p class="text-xs font-medium leading-normal tracking-[0.015em]">Home</p>
                    </a>
                    <a class="flex flex-1 flex-col items-center justify-end gap-1 text-[#9b924b]"
                        href="./all_products.html">
                        <div class="flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg"
                                width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                <path
                                    d="M80,64a8,8,0,0,1,8-8H216a8,8,0,0,1,0,16H88A8,8,0,0,1,80,64Zm136,56H88a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Zm0,64H88a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16ZM44,52A12,12,0,1,0,56,64,12,12,0,0,0,44,52Zm0,64a12,12,0,1,0,12,12A12,12,0,0,0,44,116Zm0,64a12,12,0,1,0,12,12A12,12,0,0,0,44,180Z">
                                </path>
                            </svg></div>
                        <p class="text-xs font-medium leading-normal tracking-[0.015em]">List</p>
                    </a>
                    <a class="flex flex-1 flex-col items-center justify-end gap-1 text-[#9b924b]" href="./my_cart.html">
                        <div class="flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg"
                                width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                <path
                                    d="M222.14,58.87A8,8,0,0,0,216,56H54.68L49.79,29.14A16,16,0,0,0,34.05,16H16a8,8,0,0,0,0,16h18L59.56,172.29a24,24,0,0,0,5.33,11.27,28,28,0,1,0,44.4,8.44h45.42A27.75,27.75,0,0,0,152,204a28,28,0,1,0,28-28H83.17a8,8,0,0,1-7.87-6.57L72.13,152h116a24,24,0,0,0,23.61-19.71l12.16-66.86A8,8,0,0,0,222.14,58.87ZM180,192a12,12,0,1,1-12,12A12,12,0,0,1,180,192Zm-96,0a12,12,0,1,1-12,12A12,12,0,0,1,84,192Z">
                                </path>
                            </svg></div>
                        <p class="text-xs font-medium leading-normal tracking-[0.015em]">Cart</p>
                    </a>
                    <a class="flex flex-1 flex-col items-center justify-end gap-1 text-[#1c1a0d]" href="./orders.html">
                        <div class="flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 640 640" class="w-6 h-6" fill="currentColor">
                                <path
                                    d="M256 144C256 108.7 284.7 80 320 80C355.3 80 384 108.7 384 144L384 192L256 192L256 144zM208 192L144 192C117.5 192 96 213.5 96 240L96 448C96 501 139 544 192 544L448 544C501 544 544 501 544 448L544 240C544 213.5 522.5 192 496 192L432 192L432 144C432 82.1 381.9 32 320 32C258.1 32 208 82.1 208 144L208 192zM232 240C245.3 240 256 250.7 256 264C256 277.3 245.3 288 232 288C218.7 288 208 277.3 208 264C208 250.7 218.7 240 232 240zM384 264C384 250.7 394.7 240 408 240C421.3 240 432 250.7 432 264C432 277.3 421.3 288 408 288C394.7 288 384 277.3 384 264z" />
                            </svg></div>
                        <p class="text-xs font-medium leading-normal tracking-[0.015em]">Orders</p>
                    </a>
                    <a class="flex flex-1 flex-col items-center justify-end gap-1 text-[#9b924b]" href="./profile.html">
                        <div class="flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg"
                                width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                <path
                                    d="M230.93,220a8,8,0,0,1-6.93,4H32a8,8,0,0,1-6.92-12c15.23-26.33,38.7-45.21,66.09-54.16a72,72,0,1,1,73.66,0c27.39,8.95,50.86,27.83,66.09,54.16A8,8,0,0,1,230.93,220Z">
                                </path>
                            </svg></div>
                        <p class="text-xs font-medium leading-normal tracking-[0.015em]">Profile</p>
                    </a>
                </div>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const content = document.querySelector('.content-container');
        const user = JSON.parse(localStorage.getItem('canteenUser'));
        if (!user) {
            window.location.href = './login.html';
            return;
        }

        const ongoingContainer = document.getElementById('ongoing-orders-container');
        const pastContainer = document.getElementById('past-orders-container');

        // --- UPDATED: Status badges now have background colors and themed text ---
        function getStatusBadge(status) {
            let badgeClass = 'bg-gray-200 text-gray-800'; // Default
            if (status === 'Pending') badgeClass = 'bg-blue-100 text-blue-800';
            if (status === 'Ready') badgeClass = 'bg-green-100 text-green-800';
            if (status === 'Completed') badgeClass = 'bg-gray-200 text-gray-800';
            if (status === 'Rejected') badgeClass = 'bg-red-100 text-red-700';
            
            return `<div class="text-xs font-bold py-1 px-3 rounded-full ${badgeClass}">${status}</div>`;
        }
        
        // Helper to generate list of items inside a card
        function createOrderItemsHTML(items) {
            return items.map(item => `
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-md bg-cover bg-center flex-shrink-0" style="background-image: url('${item.image_url}')"></div>
                    <p class="text-sm text-[#1c1a0d] flex-1">${item.quantity}x ${item.product_name}</p>
                    <p class="text-sm text-[#1c1a0d] font-medium">$${(item.price_per_item * item.quantity).toFixed(2)}</p>
                </div>
            `).join('');
        }
        
        // Card for ONGOING orders (always fully visible)
        function createOngoingOrderCardHTML(order) {
            return `
            <div class="bg-[#f3f2e7] p-4 rounded-lg border border-[#e5e2d0]">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-sm font-semibold text-[#1c1a0d]">Order #${order.order_id} from ${order.shop_name}</p>
                    ${getStatusBadge(order.status)}
                </div>
                <div class="border-t border-[#e5e2d0] pt-4 flex flex-col gap-3">
                    ${createOrderItemsHTML(order.items)}
                </div>
                <p class="text-right font-bold text-md text-[#1c1a0d] mt-3">$${order.total_price.toFixed(2)}</p>
            </div>`;
        }

        // --- NEW: Card for PAST orders (accordion style) ---
        function createPastOrderCardHTML(order) {
            const firstItem = order.items[0];
            let summaryText = firstItem.product_name;
            if (order.items.length > 1) {
                summaryText += ` & ${order.items.length - 1} more`;
            }
             const orderDate = new Date(order.order_date);
            const formattedDate = orderDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

            return `
            <div class="bg-white rounded-lg border border-[#e5e2d0] opacity-90">
                <div class="order-toggle p-4 flex items-center gap-4 cursor-pointer">
                    <img src="${firstItem.image_url}" class="size-12 rounded-md object-cover flex-shrink-0">
                    <div class="flex-1 overflow-hidden">
                        <p class="font-semibold text-[#1c1a0d]">${order.shop_name}</p>
                        <p class="text-sm text-[#9b924b] truncate">${summaryText}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-md text-[#1c1a0d]">$${order.total_price.toFixed(2)}</p>
                        ${getStatusBadge(order.status)}
                    </div>
                    <div class="chevron text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,53.66,90.34L128,164.69l74.34-74.35a8,8,0,0,1,11.32,11.32Z"></path></svg>
                    </div>
                </div>
                <div class="order-details">
                    <div class="border-t border-[#e5e2d0] p-4 flex flex-col gap-3">
                        <p class="text-xs text-gray-500 -mt-2 mb-2">${order.status} on ${formattedDate}</p>
                        ${createOrderItemsHTML(order.items)}
                    </div>
                </div>
            </div>`;
        }

        async function loadOrders() {
            try {
                const response = await fetch(`/orders/user/${user.id}`, { cache: 'no-cache' });
                if (!response.ok) throw new Error('Failed to fetch orders.');
                const orders = await response.json();
                console.log('Fetched orders for student:', orders);

                const ongoingOrders = orders.filter(o => o.status === 'Pending' || o.status === 'Ready');
                const pastOrders = orders.filter(o => o.status !== 'Pending' && o.status !== 'Ready');

                ongoingContainer.innerHTML = ongoingOrders.length > 0
                    ? ongoingOrders.map(createOngoingOrderCardHTML).join('')
                    : '<p class="text-center text-gray-500 py-4">No ongoing orders.</p>';

                pastContainer.innerHTML = pastOrders.length > 0
                    ? pastOrders.map(createPastOrderCardHTML).join('')
                    : '<p class="text-center text-gray-500 py-4">You have no past orders.</p>';
            } catch (error) {
                console.error('Error loading orders:', error);
                ongoingContainer.innerHTML = '<p class="text-red-500">Could not load orders.</p>';
            } finally {
                content.classList.add('loaded');
            }
        }
        
        // --- NEW: Event listener for the accordion clicks ---
        pastContainer.addEventListener('click', function(event) {
            const header = event.target.closest('.order-toggle');
            if (!header) return; // Exit if the click was not on an accordion header

            const details = header.nextElementSibling;
            header.classList.toggle('open');

            if (details.style.maxHeight) {
                details.style.maxHeight = null; // Collapse the accordion
            } else {
                details.style.maxHeight = details.scrollHeight + "px"; // Expand the accordion
            }
        });

        loadOrders();
    });
</script>
</body>

</html>