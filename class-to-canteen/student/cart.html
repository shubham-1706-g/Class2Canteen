<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - Class To Canteen</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/mobile.css">
</head>
<body>
    <header class="fixed-header">
        <div class="header-content">
            <a href="javascript:history.back()" class="back-arrow">‚Üê</a>
            <h1 class="logo">My Cart</h1>
            <!-- Hidden placeholder to keep alignment -->
            <a href="cart.html" class="cart-icon" style="visibility: hidden;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/></svg>
            </a>
        </div>
    </header>

    <main class="scrollable-content" id="cart-page">
        <div id="cart-items-container">
            <!-- Cart items will be injected here by JS -->
        </div>

        <div id="cart-summary">
            <h3>Bill Details</h3>
            <div class="summary-row">
                <span>Item Total</span>
                <span id="summary-subtotal">$0.00</span>
            </div>
            <div class="summary-row">
                <span>Delivery Fee</span>
                <span id="summary-delivery">$0.00</span>
            </div>
            <div class="summary-row">
                <span>Discount</span>
                <span id="summary-discount">-$0.00</span>
            </div>
            <hr>
            <div class="summary-row total">
                <span>To Pay</span>
                <span id="summary-total">$0.00</span>
            </div>
        </div>

        <button id="checkout-btn" class="checkout-button">Proceed to Checkout</button>
    </main>

    <div id="loading-overlay" style="display: none;">
        <div class="loader"></div>
        <p>Processing your order...</p>
    </div>


    <footer class="bottom-nav">
        <a href="home.html" class="nav-item">Home</a>
        <a href="cart.html" class="nav-item active">Cart</a>
        <a href="orders.html" class="nav-item">Orders</a>
        <a href="#" id="profile-logout" class="nav-item">Profile</a>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <script src="../js/database.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/cart.js"></script>
    <script src="../js/main.js"></script> <!-- For updateCartCounter -->
    <script>
        // These functions are specific to the cart page
        function displayCartItems() {
            const container = document.getElementById('cart-items-container');
            const cart = getCart();

            if (cart.length === 0) {
                container.innerHTML = '<p class="empty-cart">Your cart is empty. Go add some food!</p>';
                document.getElementById('checkout-btn').disabled = true;
                document.getElementById('checkout-btn').classList.add('disabled');
                return;
            }

            let itemsHtml = '';
            cart.forEach(item => {
                itemsHtml += `
                    <div class="cart-item">
                        <img src="../${item.image_url}" alt="${item.name}" class="cart-item-image">
                        <div class="cart-item-details">
                            <p class="cart-item-name">${item.name}</p>
                            <p class="cart-item-price">$${item.price.toFixed(2)}</p>
                        </div>
                        <div class="cart-item-actions">
                            <div class="quantity-control">
                                <button onclick="updateCartItemQuantity(${item.id}, ${item.quantity - 1})">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="updateCartItemQuantity(${item.id}, ${item.quantity + 1})">+</button>
                            </div>
                            <button class="remove-btn" onclick="removeFromCart(${item.id})">Remove</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = itemsHtml;
            document.getElementById('checkout-btn').disabled = false;
            document.getElementById('checkout-btn').classList.remove('disabled');
        }

        function displayCartTotal() {
            const totalInfo = getCartTotal();
            document.getElementById('summary-subtotal').textContent = `$${totalInfo.subtotal.toFixed(2)}`;
            document.getElementById('summary-delivery').textContent = `$${totalInfo.deliveryFee.toFixed(2)}`;
            document.getElementById('summary-discount').textContent = `-$${totalInfo.discount.toFixed(2)}`;
            document.getElementById('summary-total').textContent = `$${totalInfo.total.toFixed(2)}`;
        }

        function placeOrder() {
            if (!window.db) {
                alert("Database not ready. Cannot place order.");
                return;
            }

            const user = getCurrentUser();
            if (!user) {
                alert("You must be logged in to place an order.");
                return;
            }

            const cart = getCart();
            if (cart.length === 0) {
                alert("Your cart is empty.");
                return;
            }

            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';

            setTimeout(() => {
                try {
                    const totalInfo = getCartTotal();
                    const orderToken = 'CTC' + Date.now().toString().slice(-6);

                    // In a real app, you'd need to handle orders with items from multiple shops.
                    // For this project, we'll assume all items are from one shop and assign it to the shop of the first item.
                    const firstItemId = cart[0].id;
                    const shopStmt = db.prepare("SELECT shop_id FROM products WHERE id = ?");
                    shopStmt.bind([firstItemId]);
                    let shopId = 1; // Default shop
                    if(shopStmt.step()) {
                        shopId = shopStmt.get()[0];
                    }
                    shopStmt.free();

                    // Insert into orders table
                    const orderStmt = db.prepare("INSERT INTO orders (user_id, shop_id, total_amount, status, order_token) VALUES (?, ?, ?, ?, ?)");
                    orderStmt.run([user.id, shopId, totalInfo.total, 'Pending', orderToken]);
                    const orderId = db.exec("SELECT last_insert_rowid()")[0].values[0][0];
                    orderStmt.free();

                    // Insert into order_items table
                    const itemStmt = db.prepare("INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (?, ?, ?, ?)");
                    cart.forEach(item => {
                        itemStmt.run([orderId, item.id, item.quantity, item.price]);
                    });
                    itemStmt.free();

                    clearCart();

                    overlay.style.display = 'none';
                    alert(`Order Placed Successfully! Your order token is: ${orderToken}`);
                    // Store order details to be shown on confirmation page
                    sessionStorage.setItem('lastOrder', JSON.stringify({ orderId, orderToken, total: totalInfo.total }));
                    window.location.href = `orders.html?confirmation=true`;

                } catch (error) {
                    console.error("Failed to place order:", error);
                    alert("There was an error placing your order.");
                    overlay.style.display = 'none';
                }
            }, 2500); // Simulate 2.5 second processing time
        }

        document.addEventListener('DOMContentLoaded', () => {
             const checkDB = setInterval(() => {
                if (window.db) {
                    clearInterval(checkDB);

                    protectRoute();
                    updateCartCounter();
                    displayCartItems();
                    displayCartTotal();

                    document.getElementById('profile-logout').addEventListener('click', (e) => {
                        e.preventDefault();
                        logoutUser();
                    });

                    document.getElementById('checkout-btn').addEventListener('click', placeOrder);
                }
            }, 100);
        });
    </script>
</body>
</html>
